{% extends "base.html" %}
{% block title %}Dashboard Director ¬∑ Desempe√±o ambiental{% endblock %}

{% block content %}
<div class="container" style="max-width:1300px;">

  <!-- ENCABEZADO -->
  <header class="card" style="width:100%;margin-bottom:20px;">
    <h2 style="margin:0;">Desempe√±o Ambiental Corporativo (Vista P√∫blica)</h2>
    <small>Transparencia: avance hacia la carbono neutralidad, iniciativas y reportes institucionales.</small>
  </header>

  <!-- =================== 1) PROGRESO HACIA LA META (HU-09) =================== -->
  <!-- KPIs -->
  <section style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-bottom:16px;">
    <div class="card" style="text-align:center;">
      <small>Emisiones actuales</small>
      <div style="font-size:28px;font-weight:700;">
        {{ kpi_emisiones_tco2e|default:0|floatformat:1 }} <span style="font-size:14px;">tCO‚ÇÇe</span>
      </div>
    </div>
    <div class="card" style="text-align:center;">
      <small>L√≠nea base</small>
      <div style="font-size:28px;font-weight:700;">
        {{ base_year|default:"2019" }}
      </div>
    </div>
    <div class="card" style="text-align:center;">
      <small>Meta de CN</small>
      <div style="font-size:28px;font-weight:700;">
        {{ target_year|default:"2030" }}
        <div style="font-size:12px;opacity:.8;">Objetivo: {{ target_value_tco2e|default:0|floatformat:1 }} tCO‚ÇÇe</div>
      </div>
    </div>
    <div class="card" style="text-align:center;">
      <small>Cumplimiento vs meta</small>
      <div style="font-size:28px;font-weight:700;">
        {{ kpi_cumplimiento_pct|default:0|floatformat:1 }}%
      </div>
    </div>
  </section>

  <!-- Alerta de desviaci√≥n -->
  {% with desv=desviacion_pct|default:0 umbral=umbral_alerta|default:10 %}
  <section class="card" style="margin-bottom:16px;{{ desv|floatformat:1|add:'0'|floatformat:1 }};{% if desv|floatformat:2 > umbral|floatformat:2 %}border-color:#ffd2d2;background:#fff5f5{% endif %}">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
      <div>
        <strong>Desviaci√≥n actual:</strong>
        <span style="color:{% if desv > umbral %}#b32121{% else %}#1b7a4a{% endif %};font-weight:700;">
          {{ desv|floatformat:1 }}%
        </span>
        <small style="margin-left:6px;opacity:.8;">(Umbral: {{ umbral }}%)</small>
      </div>
      {% if desv > umbral %}
        <div class="btn" style="width:auto;background:#ffe8e8;color:#6a1b1b;">üîî Alerta: sobre la proyecci√≥n anual</div>
      {% else %}
        <div class="btn" style="width:auto;">‚úÖ En rango esperado</div>
      {% endif %}
    </div>
  </section>
  {% endwith %}

  <!-- Gr√°fico hist√≥rico: emisiones vs meta -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin-top:0;">Evoluci√≥n de emisiones vs meta</h3>
    <small>Serie hist√≥rica de tCO‚ÇÇe comparada con la proyecci√≥n hacia la carbono neutralidad.</small>
    <canvas id="chartHistorico" height="140" style="margin-top:14px;"></canvas>

    <!-- Indicadores adicionales -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:16px;">
      <div class="card" style="text-align:center;">
        <small>Reducci√≥n lograda</small>
        <div style="font-size:24px;font-weight:700;">
          {{ reduccion_lograda_tco2e|default:0|floatformat:1 }} tCO‚ÇÇe
        </div>
      </div>
      <div class="card" style="text-align:center;">
        <small>Tasa anual de disminuci√≥n</small>
        <div style="font-size:24px;font-weight:700;">
          {{ tasa_anual_disminucion_pct|default:0|floatformat:1 }}%
        </div>
      </div>
      <div class="card" style="text-align:center;">
        <small>Desviaci√≥n vs proyecci√≥n</small>
        <div style="font-size:24px;font-weight:700;">
          {{ desviacion_pct|default:0|floatformat:1 }}%
        </div>
      </div>
    </div>
  </section>

  <!-- Emisiones por alcance -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin:0;">Distribuci√≥n de emisiones por alcance</h3>
    <small>Alcance 1 (directas), 2 (energ√≠a), 3 (otras indirectas).</small>
    <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:16px;margin-top:12px;align-items:center;">
      <canvas id="chartAlcance" height="140"></canvas>
      <table style="width:100%;border-collapse:collapse;">
        <thead style="background:#f5f7fa;">
          <tr><th>Alcance</th><th>tCO‚ÇÇe</th></tr>
        </thead>
        <tbody>
          {% for a in emisiones_por_alcance %}
          <tr style="background:#fff;border-bottom:1px solid var(--borde);">
            <td style="padding:8px;">{{ a.alcance }}</td>
            <td><b>{{ a.t|default:0|floatformat:1 }}</b></td>
          </tr>
          {% empty %}
          <tr><td colspan="2" style="text-align:center;color:#888;">Sin datos</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- =================== 2) REPORTES INSTITUCIONALES (HU-13) =================== -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin:0;">Reportes institucionales</h3>
    <small>Generaci√≥n y control de versiones de informes PDF oficiales.</small>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
      <button class="btn" {% if not can_generate_pdf %}disabled{% endif %} style="width:auto;">
        üßæ Generar reporte PDF
      </button>
      <button class="btn" style="width:auto;background:#edf6ff;color:#0c3a67;">
        üìß Enviar a responsables
      </button>
      <div style="flex:1"></div>
      <small>Metodolog√≠a: GHG Protocol ¬∑ Factores de emisi√≥n trazables</small>
    </div>

    <table style="width:100%;margin-top:12px;border-collapse:collapse;">
      <thead style="background:#f5f7fa;">
        <tr><th>Fecha</th><th>Versi√≥n</th><th>Generado por</th><th>Ruta/Documento</th></tr>
      </thead>
      <tbody>
        {% for r in historial_reportes %}
        <tr style="background:#fff;border-bottom:1px solid var(--borde);">
          <td style="padding:8px;">{{ r.fecha_generacion|date:"Y-m-d H:i" }}</td>
          <td>{{ r.version|default:"1.0" }}</td>
          <td>{{ r.generado_por.username|default:"‚Äî" }}</td>
          <td>{{ r.ruta_archivo|default:r.archivo.url }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" style="text-align:center;color:#888;">A√∫n no hay reportes generados</td></tr>
        {% endfor %}
      </tbody>
    </table>
    <small style="opacity:.8;">Solo personal autorizado puede generar/firmar PDFs oficiales.</small>
  </section>

  <!-- =================== 3) EXPORTACI√ìN EXCEL (HU-14) =================== -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin:0;">Exportaci√≥n de datos</h3>
    <small>Descarga de inventario completo para an√°lisis externos (Excel).</small>

    <form action="#" method="get" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
      <select name="pais" style="padding:8px;border:1px solid var(--borde);border-radius:10px;min-width:160px">
        <option value="">Pa√≠s: todos</option>
        {% for p in paises|default:list %}
          <option>{{ p }}</option>
        {% endfor %}
      </select>

      <select name="year" style="padding:8px;border:1px solid var(--borde);border-radius:10px;min-width:140px">
        <option value="">A√±o: todos</option>
        {% for y in years|default:list %}
          <option>{{ y }}</option>
        {% endfor %}
      </select>

      <select name="alcance" style="padding:8px;border:1px solid var(--borde);border-radius:10px;min-width:160px">
        <option value="">Alcance: 1, 2, 3</option>
        <option>1</option><option>2</option><option>3</option>
      </select>

      <button class="btn" type="submit" style="width:auto;">Filtrar</button>
      <div style="flex:1"></div>
      <button class="btn" type="button" style="width:auto;">üíæ Exportar Excel</button>
    </form>

    <small style="opacity:.8;">La descarga registra usuario y fecha para trazabilidad.</small>
  </section>

  <!-- =================== 4) MONITOREO GLOBAL (CONSOLIDADO) =================== -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin:0;">Consolidado global</h3>
    <small>Emisiones por pa√≠s y cumplimiento normativo general.</small>

    <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:16px;margin-top:12px;align-items:center;">
      <canvas id="chartPaises" height="140"></canvas>

      <table style="width:100%;border-collapse:collapse;">
        <thead style="background:#f5f7fa;">
          <tr><th>Pa√≠s</th><th>tCO‚ÇÇe</th><th>Cumplimiento</th></tr>
        </thead>
        <tbody>
          {% for c in consolidado_paises %}
          <tr style="background:#fff;border-bottom:1px solid var(--borde);">
            <td style="padding:8px;">{{ c.pais }}</td>
            <td><b>{{ c.tco2e|default:0|floatformat:1 }}</b></td>
            <td>
              <span style="color:{% if c.cumplimiento_pct|default:0 > 79 %}#1b7a4a{% else %}#b36b00{% endif %}">
                {{ c.cumplimiento_pct|default:0|floatformat:0 }}%
              </span>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="3" style="text-align:center;color:#888;">Sin datos consolidados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Comparador de unidades -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin:0;">Ranking por unidad de negocio</h3>
    <small>Emisiones, reducci√≥n lograda y posici√≥n relativa.</small>
    <table style="width:100%;margin-top:12px;border-collapse:collapse;">
      <thead style="background:#f5f7fa;">
        <tr><th>Unidad</th><th>tCO‚ÇÇe</th><th>% reducci√≥n</th><th>Ranking</th></tr>
      </thead>
      <tbody>
        {% for u in ranking_unidades %}
        <tr style="background:#fff;border-bottom:1px solid var(--borde);">
          <td style="padding:8px;">{{ u.unidad }}</td>
          <td>{{ u.tco2e|default:0|floatformat:1 }}</td>
          <td>{{ u.reduccion_pct|default:0|floatformat:1 }}%</td>
          <td>#{{ forloop.counter }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" style="text-align:center;color:#888;">Sin datos para ranking</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- =================== 5) INICIATIVAS (LECTURA) =================== -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin:0;">Portafolio de iniciativas</h3>
    <small>Impacto esperado y avance de proyectos de mitigaci√≥n.</small>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">
      <div style="overflow:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead style="background:#f5f7fa;">
            <tr><th>Nombre</th><th>Categor√≠a</th><th>Avance</th><th>Reducci√≥n (tCO‚ÇÇe)</th></tr>
          </thead>
          <tbody>
            {% for i in iniciativas %}
            <tr style="background:#fff;border-bottom:1px solid var(--borde);">
              <td style="padding:8px;">{{ i.nombre }}</td>
              <td>{{ i.categoria }}</td>
              <td>
                <div style="background:#e8eef3;border-radius:6px;height:8px;position:relative;">
                  <span style="background:#7acaa3;width:{{ i.avance }}%;position:absolute;top:0;bottom:0;left:0;border-radius:6px;"></span>
                </div>
                <small>{{ i.avance|floatformat:0 }}%</small>
              </td>
              <td>{{ i.reduccion_esperada|default:0|floatformat:1 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" style="text-align:center;color:#888;">Sin iniciativas registradas</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div>
        <div class="card" style="text-align:center;">
          <small>Costo promedio por tCO‚ÇÇe evitada</small>
          <div style="font-size:24px;font-weight:700;">
            {{ costo_promedio_por_ton|default:0|floatformat:2 }} USD/tCO‚ÇÇe
          </div>
        </div>
        <div class="card" style="text-align:center;">
          <small>Aporte estimado a la meta</small>
          <div style="font-size:24px;font-weight:700;">
            {{ aporte_proyectos_pct|default:0|floatformat:1 }}%
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- =================== 6) CONTROL Y TRAZABILIDAD =================== -->
  <section class="card" style="margin-bottom:24px;">
    <h3 style="margin:0;">Trazabilidad</h3>
    <small>Historial de reportes y validaciones oficiales.</small>

    <table style="width:100%;margin-top:12px;border-collapse:collapse;">
      <thead style="background:#f5f7fa;">
        <tr><th>Fecha</th><th>Autor</th><th>Prop√≥sito</th><th>Estado</th></tr>
      </thead>
      <tbody>
        {% for h in historial_validaciones %}
        <tr style="background:#fff;border-bottom:1px solid var(--borde);">
          <td style="padding:8px;">{{ h.fecha|date:"Y-m-d H:i" }}</td>
          <td>{{ h.autor }}</td>
          <td>{{ h.proposito|default:"‚Äî" }}</td>
          <td>{{ h.estado|default:"Validado" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" style="text-align:center;color:#888;">Sin registros a√∫n</td></tr>
        {% endfor %}
      </tbody>
    </table>
    <small style="opacity:.8;">Esta vista es de solo lectura. La publicaci√≥n oficial bloquea ediciones posteriores.</small>
  </section>

</div>

<!-- =================== CHARTS =================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ---------- Datos desde el backend (con defaults seguros) ----------
  const labelsHistorico = {{ series_historico_labels|default:"[]"|safe }};
  const dataHistorico = {{ series_historico_emisiones|default:"[]"|safe }};
  const dataMeta = {{ series_historico_meta|default:"[]"|safe }};

  const alcLabels = {{ emisiones_alcance_labels|default:"['1','2','3']"|safe }};
  const alcValues = {{ emisiones_alcance_values|default:"[0,0,0]"|safe }};

  const paisLabels = {{ consolidado_paises_labels|default:"[]"|safe }};
  const paisValues = {{ consolidado_paises_tco2e|default:"[]"|safe }};

  // ---------- Gr√°fico hist√≥rico (l√≠neas) ----------
  const ctxHist = document.getElementById("chartHistorico");
  new Chart(ctxHist, {
    type: "line",
    data: {
      labels: labelsHistorico,
      datasets: [
        {
          label: "Emisiones (tCO‚ÇÇe)",
          data: dataHistorico,
          borderColor: "#1b7a4a",
          backgroundColor: "rgba(122,202,163,0.25)",
          fill: true,
          tension: 0.3,
          pointRadius: 2
        },
        {
          label: "Meta proyectada",
          data: dataMeta,
          borderColor: "#0d2a3e",
          backgroundColor: "rgba(13,42,62,0.10)",
          fill: false,
          borderDash: [6,4],
          tension: 0.3,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: {
        x: { title: { display: true, text: "A√±o" }},
        y: { title: { display: true, text: "tCO‚ÇÇe" }, beginAtZero: true }
      }
    }
  });

  // ---------- Emisiones por alcance (doughnut) ----------
  const ctxAlc = document.getElementById("chartAlcance");
  new Chart(ctxAlc, {
    type: "doughnut",
    data: {
      labels: alcLabels,
      datasets: [{
        data: alcValues,
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { position: "bottom" } },
      cutout: "62%"
    }
  });

  // ---------- Emisiones por pa√≠s (barras) ----------
  const ctxPais = document.getElementById("chartPaises");
  new Chart(ctxPais, {
    type: "bar",
    data: {
      labels: paisLabels,
      datasets: [{
        label: "tCO‚ÇÇe",
        data: paisValues
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: "Pa√≠s" }},
        y: { title: { display: true, text: "tCO‚ÇÇe" }, beginAtZero: true }
      }
    }
  });
});
</script>
{% endblock %}
