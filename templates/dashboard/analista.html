{% extends "base.html" %}
{% block title %}Dashboard ¬∑ Analista Ambiental{% endblock %}

{% block content %}
<div class="container" style="max-width:1300px;">

  <!-- ENCABEZADO -->
  <header class="card" style="width:100%;margin-bottom:20px;">
    <h2 style="margin:0;">Panel del Analista Ambiental</h2>
    <small>Monitoreo de cumplimiento, inventario GEI, simulaciones e iniciativas.</small>

    <!-- Barra superior -->
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;align-items:center;">
      <form action="#" method="get" style="flex:1;min-width:280px;display:flex;gap:8px;">
        <input name="q" type="search" placeholder="Buscar (fuente, pa√≠s, normativa, iniciativa‚Ä¶)"
               style="flex:1;padding:10px;border:1px solid var(--borde);border-radius:10px;">
        <button class="btn" type="submit" style="width:auto;">Buscar</button>
      </form>
      <button class="btn" type="button" style="width:auto;background:#ffe8e8;color:#6a1b1b">
        üîî {{ alertas_total }} alertas
      </button>
      <a class="btn" href="/admin/" style="width:auto;">‚öôÔ∏è Administraci√≥n</a>
    </div>
  </header>

  <!-- KPIs RESUMEN -->
  <section style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:20px;">
    <div class="card" style="text-align:center;">
      <small>Normativas registradas</small>
      <div style="font-size:28px;font-weight:700;">{{ normativas_total }}</div>
    </div>
    <div class="card" style="text-align:center;">
      <small>Emisiones registradas</small>
      <div style="font-size:28px;font-weight:700;">{{ emisiones_total }}</div>
    </div>
    <div class="card" style="text-align:center;">
      <small>Iniciativas activas</small>
      <div style="font-size:28px;font-weight:700;">{{ iniciativas_total }}</div>
    </div>
    <div class="card" style="text-align:center;">
      <small>Reportes generados</small>
      <div style="font-size:28px;font-weight:700;">{{ reportes_total }}</div>
    </div>
  </section>

  <!-- ESTADO NORMATIVO -->
  <section class="card" style="width:100%;margin-bottom:24px;">
    <h3>Estado normativo y cumplimiento</h3>
    <small>Resumen de leyes ambientales registradas en los distintos pa√≠ses</small>

    <table style="width:100%;margin-top:10px;border-collapse:collapse;text-align:left;">
      <thead style="background:#f5f7fa;">
        <tr>
          <th style="padding:8px;">Pa√≠s</th>
          <th>Normativa</th>
          <th>Tipo</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for n in normativas %}
        <tr style="background:#fff;border-bottom:1px solid var(--borde);">
          <td style="padding:8px;">{{ n.pais }}</td>
          <td>{{ n.nombre }}</td>
          <td>{{ n.tipo }}</td>
          <td style="color:{% if n.estado %}#1b7a4a{% else %}#b32121{% endif %}">
            {% if n.estado %}Cumple{% else %}No cumple{% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" style="text-align:center;color:#888;">Sin normativas registradas</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- INVENTARIO DE EMISIONES -->
  <section class="card" style="width:100%;margin-bottom:24px;">
    <h3>Inventario de Emisiones GEI</h3>
    <small>√öltimos registros de emisiones convertidas a tCO‚ÇÇe</small>

    <div style="overflow-x:auto;margin-top:10px;">
      <table style="width:100%;border-collapse:collapse;text-align:left;">
        <thead style="background:#f5f7fa;">
          <tr>
            <th>Fecha</th><th>Unidad</th><th>Fuente</th><th>Alcance</th><th>Consumo</th><th>tCO‚ÇÇe</th>
          </tr>
        </thead>
        <tbody>
          {% for e in emisiones %}
          <tr style="background:#fff;border-bottom:1px solid var(--borde);">
            <td style="padding:6px;">{{ e.fecha }}</td>
            <td>{{ e.unidad_negocio }}</td>
            <td>{{ e.fuente }}</td>
            <td>{{ e.alcance }}</td>
            <td>{{ e.consumo }} {{ e.unidad }}</td>
            <td><b>{{ e.emisiones|floatformat:2 }}</b></td>
          </tr>
          {% empty %}
          <tr><td colspan="6" style="text-align:center;color:#888;">Sin emisiones registradas</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- GR√ÅFICO DE EMISIONES -->
    <canvas id="graficoEmisiones" height="120" style="margin-top:20px;"></canvas>
  </section>

  <!-- INICIATIVAS -->
  <section class="card" style="width:100%;margin-bottom:24px;">
    <h3>Iniciativas de mitigaci√≥n</h3>
    <small>Proyectos activos con avance porcentual</small>

    <table style="width:100%;margin-top:10px;border-collapse:collapse;text-align:left;">
      <thead style="background:#f5f7fa;">
        <tr>
          <th>Nombre</th><th>Categor√≠a</th><th>Ubicaci√≥n</th><th>Avance</th><th>Reducci√≥n (tCO‚ÇÇe)</th>
        </tr>
      </thead>
      <tbody>
        {% for i in iniciativas %}
        <tr style="background:#fff;border-bottom:1px solid var(--borde);">
          <td style="padding:8px;">{{ i.nombre }}</td>
          <td>{{ i.categoria }}</td>
          <td>{{ i.ubicacion }}</td>
          <td>
            <div style="background:#e8eef3;border-radius:6px;height:8px;position:relative;">
              <span style="background:#7acaa3;width:{{ i.avance }}%;position:absolute;top:0;bottom:0;left:0;border-radius:6px;"></span>
            </div>
            <small>{{ i.avance|floatformat:0 }}%</small>
          </td>
          <td>{{ i.reduccion_esperada|floatformat:1 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" style="text-align:center;color:#888;">Sin iniciativas registradas</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- REPORTES -->
  <section class="card" style="width:100%;">
    <h3>Reportes recientes</h3>
    <table style="width:100%;margin-top:10px;border-collapse:collapse;text-align:left;">
      <thead style="background:#f5f7fa;">
        <tr><th>Tipo</th><th>Fecha</th><th>Ruta archivo</th></tr>
      </thead>
      <tbody>
        {% for r in reportes %}
        <tr style="background:#fff;border-bottom:1px solid var(--borde);">
          <td style="padding:8px;">{{ r.tipo }}</td>
          <td>{{ r.fecha_generacion|date:"Y-m-d" }}</td>
          <td>{{ r.ruta_archivo }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" style="text-align:center;color:#888;">Sin reportes generados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

</div>

<!-- === GR√ÅFICO DE EMISIONES (Chart.js) === -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("graficoEmisiones");
  const dataLabels = [{% for e in emisiones reversed %}"{{ e.fecha|date:'Y-m-d' }}",{% endfor %}];
  const dataValues = [{% for e in emisiones reversed %}{{ e.emisiones|default:0 }},{% endfor %}];

  new Chart(ctx, {
    type: "line",
    data: {
      labels: dataLabels,
      datasets: [{
        label: "tCO‚ÇÇe registradas",
        data: dataValues,
        fill: true,
        borderColor: "#1b7a4a",
        backgroundColor: "rgba(122,202,163,0.3)",
        tension: 0.3,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: "Fecha" }},
        y: { title: { display: true, text: "tCO‚ÇÇe" }, beginAtZero: true }
      }
    }
  });
});
</script>
{% endblock %}
