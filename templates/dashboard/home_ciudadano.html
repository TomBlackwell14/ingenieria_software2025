{% extends "base.html" %}
{% load static %}
{% block title %}Ciudadano · Transparencia y Avances{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ciudadano.css' %}">
{% endblock %}

{% block content %}
<header class="c-header">
  <div class="c-brand">
    <span class="c-pill">🍃</span>
    <h1>Transparencia y avances</h1>
  </div>
  <p class="c-sub">Datos públicos sobre sostenibilidad: iniciativas, logros y reportes disponibles.</p>
</header>

<main class="c-container">

  <!-- ==================== LOGROS DESTACADOS ==================== -->
  <section class="card">
    <header class="c-section-head">
      <h2>Logros destacados</h2>
      <small>Principales avances visibles para la comunidad.</small>
    </header>

    {% if logros %}
    <div class="goals-grid" style="margin-top:.75rem;">
      {% for g in logros %}
      <article class="goal">
        <h4>{{ g.nombre }}</h4>
        <p>{{ g.descripcion }}</p>
        <progress max="100" value="{{ g.avance|default:0 }}" aria-label="{{ g.avance }}%"></progress>
        <small>{{ g.avance|default:0 }}% completado · {{ g.categoria }}{% if g.ubicacion %} · {{ g.ubicacion }}{% endif %}</small>
        {% if g.imagen %}
        <img src="{{ g.imagen.url }}" alt="{{ g.nombre }}" style="width:100%;border-radius:12px;margin-top:.5rem;">
        {% endif %}
      </article>
      {% endfor %}
    </div>
    {% else %}
    <p class="muted">Aún no hay logros destacados publicados.</p>
    {% endif %}
  </section>

  <!-- ==================== NOTICIAS ==================== -->
  <section class="c-news card">
    <header class="c-section-head">
      <h2>Últimas noticias</h2>
      <small>Publicaciones y avances recientes para el público.</small>
    </header>

    {% if noticias %}
    <ul class="news-list">
      {% for n in noticias %}
      <li class="news-item">
        <h4>{{ n.titulo }}</h4>
        <p>{{ n.resumen }}</p>
        {% if n.fecha %}<time datetime="{{ n.fecha|date:'Y-m-d' }}">{{ n.fecha|date:"d M Y" }}</time>{% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="muted">No hay noticias publicadas por ahora.</p>
    {% endif %}
  </section>

  <!-- ==================== REPORTES PÚBLICOS ==================== -->
  <section class="card">
    <header class="c-section-head">
      <h2>Reportes públicos</h2>
      <small>Documentos de sostenibilidad, emisiones y compromisos.</small>
    </header>

    {% if reportes_publicos %}
    <table>
      <thead>
        <tr><th>Nombre</th><th>Tipo</th><th>Fecha</th><th>Descargar</th></tr>
      </thead>
      <tbody>
        {% for r in reportes_publicos %}
        <tr>
          <td>{{ r.nombre }}</td>
          <td>{{ r.tipo }}</td>
          <td>{{ r.fecha_generacion|date:"Y-m-d" }}</td>
          <td>
            {% if r.archivo %}
              <a class="btn" href="{{ r.archivo.url }}" download>📄 Descargar</a>
            {% else %}
              <span class="muted">Sin archivo</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="muted">No hay reportes disponibles en este momento.</p>
    {% endif %}
  </section>

  <!-- ==================== BUSCADOR SIMPLE (OPCIONAL) ==================== -->
  <section class="card">
    <header class="c-section-head">
      <h2>Buscar contenidos</h2>
      <small>Normativas e iniciativas públicas (búsqueda simple).</small>
    </header>

    <form action="" method="get" class="c-filters-grid" id="filters-form">
      <div class="f-group" style="grid-column: 1 / -1;">
        <label for="q">Palabras clave</label>
        <input id="q" name="q" type="search" placeholder="Ej: Energía, Reciclaje, Chile, etc.">
      </div>
      <div class="f-actions">
        <button type="submit" class="btn primary">Buscar</button>
        <button type="reset" class="btn ghost" id="btn-clear">Limpiar</button>
      </div>
    </form>

    {% if normativas or iniciativas %}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:1rem;">
      <div>
        <h4>Normativas</h4>
        <ul class="news-list">
          {% for n in normativas %}
          <li class="news-item">
            <h4 style="margin:0">{{ n.nombre }}</h4>
            <p>{{ n.pais }} · {{ n.tipo }}</p>
          </li>
          {% empty %}
          <li class="news-item"><p class="muted">Sin resultados.</p></li>
          {% endfor %}
        </ul>
      </div>
      <div>
        <h4>Iniciativas</h4>
        <ul class="news-list">
          {% for i in iniciativas %}
          <li class="news-item">
            <h4 style="margin:0">{{ i.nombre }}</h4>
            <p>{{ i.categoria }}{% if i.ubicacion %} · {{ i.ubicacion }}{% endif %}</p>
          </li>
          {% empty %}
          <li class="news-item"><p class="muted">Sin resultados.</p></li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
  </section>

  <!-- ==================== ACCESO A ROLES INTERNOS ==================== -->
  <section class="card">
    <header class="c-section-head">
      <h2>Acceso</h2>
      <small>Si formas parte del equipo, inicia sesión para continuar.</small>
    </header>

    <!-- Botón inicial -->
    <button id="btn-login-toggle" class="btn primary">Iniciar sesión</button>

    <!-- Opciones de rol (ocultas hasta click) -->
    <div id="roles-wrapper" style="display:none; margin-top: 12px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;">
        <a class="btn ghost" href="/accounts/login/?next={{ '/dashboard/director/'|urlencode }}">Director</a>
        <a class="btn ghost" href="/accounts/login/?next={{ '/dashboard/analista/'|urlencode }}">Analista</a>
        <a class="btn ghost" href="/accounts/login/?next={{ '/dashboard/operador/'|urlencode }}">Operario</a>
      </div>
      <small style="display:block;opacity:.75;margin-top:.5rem;">Tras iniciar sesión, te redirigiremos al panel correspondiente.</small>
    </div>
  </section>

</main>

<script>
/* Toggle simple para mostrar las opciones de rol tras click en "Iniciar sesión" */
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btn-login-toggle');
  const box = document.getElementById('roles-wrapper');
  if(btn && box){
    btn.addEventListener('click', () => {
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
    });
  }

  // LIMPIAR BUSQUEDA
  const form = document.getElementById('filters-form');
  const clear = document.getElementById('btn-clear');
  if(clear && form){
    clear.addEventListener('click', () => form.reset());
  }
});
</script>
{% endblock %}
