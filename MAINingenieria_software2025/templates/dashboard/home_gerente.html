{% extends "base.html" %}
{% load static %}
{% block title %}Panel Gerente ¬∑ Cencosud Gases Free{% endblock %}
{% block page_class %}dashboard-gerente{% endblock %}

{% block content %}
<!-- =========================================================
     BARRA SUPERIOR
     ========================================================= -->
<header class="topbar role-gerente" role="banner">
  <div class="brand">
    <a class="brand__logo" href="#" aria-label="Ir al inicio"><span class="logo">üè¢</span></a>
    <div class="brand-text">
      <h1 class="brand-text__title">Cencosud <span style="color:var(--color-accent)">Gases Free</span></h1>
      <p class="brand-text__tagline">Panel del Gerente Regional</p>
    </div>
  </div>

  <nav class="nav-links">
    <a href="#resumen">Resumen</a>
    <a href="#indicadores">Indicadores</a>
    <a href="#reportes">Reportes</a>
    <a href="#estrategias">Estrategias</a>
  </nav>

  <div class="actions">
    <!-- NOTA: SI USAS LOGOUT POR POST, REEMPLAZAR POR UN FORM CON METHOD=POST -->
    <a class="btn btn--primary" href="{% url 'role_login' %}">Cerrar sesi√≥n</a>
  </div>
</header>

<!-- =========================================================
     CONTENIDO PANEL GERENTE
     ========================================================= -->
<main class="dashboard-gerente" style="padding:clamp(20px,3vw,40px);max-width:1400px;margin:0 auto;display:grid;gap:32px;">

  <!-- =========================================================
       RESUMEN EJECUTIVO + KPIS HU-09 (CA-09-1)
       ========================================================= -->
  <section id="resumen" class="header-card" style="background:#fff;border-radius:16px;box-shadow:var(--shadow-light);padding:1.5rem;">
    <h2 style="margin:0 0 .5rem 0;">Resumen Ejecutivo</h2>
    <p style="margin:0;color:#444">Resumen de las operaciones regionales y desempe√±o ambiental.</p>

    <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
      <span style="font-size:.9rem;background:#f3f5f7;border:1px solid var(--borde);border-radius:999px;padding:.3rem .8rem;">
        √öltima actualizaci√≥n: {{ kpis.fecha_actualizacion|default:"‚Äî" }}
      </span>
      <a href="{{ links.metodologia|default:'#' }}" style="font-size:.9rem;background:#f3f5f7;border:1px solid var(--borde);border-radius:999px;padding:.3rem .8rem;text-decoration:none;">
        Metodolog√≠a y factores GHG
      </a>
    </div>

    <!-- TARJETAS BASE/META/ACTUAL (CA-09-1) -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;margin-top:1.5rem;">
      <article style="background:#fff;border-radius:16px;box-shadow:var(--shadow-light);padding:1.2rem;">
        <h4 style="margin:0 0 .5rem 0;color:#0d47a1;">L√≠nea base</h4>
        <strong style="font-size:1.8rem;">{{ metas.linea_base_tco2e|default:"‚Äî" }}</strong>
        <p style="margin:.5rem 0 0 0;color:#666;">tCO2e (a√±o base: {{ metas.anio_base|default:"‚Äî" }})</p>
      </article>
      <article style="background:#fff;border-radius:16px;box-shadow:var(--shadow-light);padding:1.2rem;">
        <h4 style="margin:0 0 .5rem 0;color:#2e7d32;">Meta</h4>
        <strong style="font-size:1.8rem;">{{ metas.meta_tco2e|default:"‚Äî" }}</strong>
        <p style="margin:.5rem 0 0 0;color:#666;">tCO2e objetivo {{ metas.anio_meta|default:"‚Äî" }}</p>
      </article>
      <article style="background:#fff;border-radius:16px;box-shadow:var(--shadow-light);padding:1.2rem;">
        <h4 style="margin:0 0 .5rem 0;color:#c62828;">Emisiones actuales</h4>
        <strong style="font-size:1.8rem;">{{ metas.actual_tco2e|default:"‚Äî" }}</strong>
        <p style="margin:.5rem 0 0 0;color:#666;">tCO2e ({{ kpis.periodo_actual|default:"‚Äî" }})</p>
      </article>
    </div>

    <!-- Tendencia de emisiones 2015‚Äì2025 con curvas -->
    <section class="chart-card" style="background:#fff;border-radius:16px;box-shadow:var(--shadow-light);padding:1.5rem;margin-top:2rem;">
      <h3 style="margin:.5rem 0 0 0;">Tendencia de emisiones 2015‚Äì2025</h3>
      <canvas id="emisionesCurvasChart" style="margin-top:1.5rem;width:100%;height:350px;"></canvas>
    </section>
  </section>

  <!-- =========================================================
       INDICADORES HU-09 (CA-09-2) + PROGRESO HACIA LA META
       ========================================================= -->
  <section id="indicadores" class="chart-card" style="background:#fff;border-radius:12px;box-shadow:var(--shadow-light);padding:1.1rem;">
    <h3 style="margin:.2rem 0 0 0;">Progreso hacia la meta</h3>

    <!-- BARRA PROGRESO: CALCULADA EN JS SEGUN LB, META, ACTUAL -->
    <div id="progress-wrap" style="margin-top:1rem;">
      <div aria-label="Barra de progreso" style="position:relative;height:16px;background:#eef2f3;border-radius:999px;overflow:hidden;">
        <div id="progress-bar" style="position:absolute;left:0;top:0;bottom:0;width:0%;background:var(--color-accent);transition:width .5s ease;"></div>
      </div>
      <p id="progress-text" style="color:#444;font-size:.9rem;margin-top:.5rem;">Avance: ‚Äî</p>
    </div>

    <!-- INDICADORES CLAVE (CA-09-2) -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;margin-top:.75rem;">
      <article style="background:#fff;border-radius:12px;box-shadow:var(--shadow-light);padding:.9rem;">
        <h4 style="margin:0 0 .25rem 0;color:#333;">Reduccion lograda</h4>
        <strong id="kpi-reduccion-lograda" style="font-size:1.4rem;">‚Äî</strong>
        <p style="margin:.25rem 0 0 0;color:#666;">Vs linea base</p>
      </article>
      <article style="background:#fff;border-radius:12px;box-shadow:var(--shadow-light);padding:.9rem;">
        <h4 style="margin:0 0 .25rem 0;color:#333;">Cumplimiento</h4>
        <strong id="kpi-cumplimiento" style="font-size:1.4rem;">‚Äî</strong>
        <p style="margin:.25rem 0 0 0;color:#666;">Actual vs meta</p>
      </article>
      <article style="background:#fff;border-radius:12px;box-shadow:var(--shadow-light);padding:.9rem;">
        <h4 style="margin:0 0 .25rem 0;color:#333;">Desviacion</h4>
        <strong id="kpi-desviacion" style="font-size:1.4rem;">‚Äî</strong>
        <p style="margin:.25rem 0 0 0;color:#666;">Alerta si supera umbral</p>
      </article>
    </div>

    <!-- DATOS PARA JS (NO VISIBLE) -->
    <div id="meta-data"
         data-lb="{{ metas.linea_base_tco2e|default:'0' }}"
         data-meta="{{ metas.meta_tco2e|default:'0' }}"
         data-actual="{{ metas.actual_tco2e|default:'0' }}"
         data-umbral="{{ metas.umbral_desviacion_pct|default:'10' }}">
    </div>
  </section>

  <!-- =========================================================
       TOP FUENTES E INVENTARIO
       ========================================================= -->
  <section style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
    <article class="card" style="background:#fff;border-radius:12px;box-shadow:var(--shadow-light);padding:1.1rem;">
      <header style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;">Top fuentes de emision</h3>
        <a class="btn btn--ghost" href="{{ links.inventario|default:'#' }}">Inventario</a>
      </header>

      {% if top_fuentes %}
        <div class="table-scroll" style="margin-top:.75rem;overflow:auto;max-height:300px;">
          <table class="table">
            <thead><tr><th>Unidad</th><th>Fuente</th><th>Alcance</th><th>tCO2e</th></tr></thead>
            <tbody>
              {% for f in top_fuentes %}
              <tr>
                <td>{{ f.unidad }}</td><td>{{ f.fuente }}</td><td>{{ f.alcance }}</td><td>{{ f.tco2e }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div style="margin-top:.75rem;padding:.8rem;border:1px dashed var(--borde);border-radius:10px;color:#666;">Sin datos</div>
      {% endif %}
    </article>

    <!-- =======================================================
         REPORTES HU-13 (CA-13-1, CA-13-2, CA-13-3)
         ======================================================= -->
    <article id="reportes" class="card" style="background:#fff;border-radius:12px;box-shadow:var(--shadow-light);padding:1.1rem;">
      <h3 style="margin:0 0 .5rem 0;">Reportes y Descargas</h3>

      <!-- BOTONES DE DESCARGA -->
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
        <a class="btn btn--primary" href="{{ links.descargar_pdf|default:'#' }}">Descargar PDF</a>
        <a class="btn btn--secondary" href="{{ links.descargar_excel|default:'#' }}">Descargar Excel</a>
      </div>

      <!-- METADATOS OBLIGATORIOS (CA-13-3) -->
      <div style="margin-top:.75rem;font-size:.92rem;color:#444;">
        <p style="margin:.25rem 0;">Fecha reporte: <strong>{{ report.fecha|default:kpis.fecha_actualizacion|default:"‚Äî" }}</strong></p>
        <p style="margin:.25rem 0;">Version: <strong>{{ report.version|default:"v1.0" }}</strong></p>
      </div>

      <!-- CHECKLIST DE CONTENIDOS DEL PDF (CA-13-1, CA-13-2) -->
      <ul style="margin:.5rem 0 0 1rem;color:#555;font-size:.92rem;">
        <li>Emisiones por alcance (1, 2 y 3) y por fuente</li>
        <li>Metodologia y factores de emision aplicados</li>
        <li>Fecha y version del documento</li>
      </ul>

      <!-- NOTA: SI DESEAS ENVIAR PARAMETROS AL BACKEND PARA INCLUIR SECCIONES, AGREGA UN FORM AQUi -->
    </article>
  </section>

  <!-- =========================================================
       ALERTAS HU-09 (CA-09-3)
       ========================================================= -->
  <section aria-label="Alertas" style="background:#fff;border-radius:12px;box-shadow:var(--shadow-light);padding:1.1rem;">
    <h3 style="margin:.2rem 0 0 0;">Alertas</h3>
    <div id="alertas-auto"></div>

    {% if alertas %}
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.75rem;margin-top:.75rem;">
        {% for a in alertas %}
        <!-- Correcci√≥n final: Usar clases CSS din√°micas para alertas -->
        <article class="alert {{ a.nivel }}">
          <strong>{{ a.titulo }}</strong>
          <p style="margin:0;color:#555;">{{ a.descripcion }}</p>
        </article>
        {% endfor %}
      </div>
    {% else %}
      <div style="margin-top:.5rem;padding:.8rem;border:1px dashed var(--borde);border-radius:10px;color:#666;">Sin alertas pendientes</div>
    {% endif %}
  </section>

  <footer style="text-align:center;color:#777;">
    <small>¬© 2025 Cencosud Gases Free ‚Äî Direccion Ambiental Global</small>
  </footer>
</main>

<!-- =========================================================
     SCRIPT: CALCULO DE INDICADORES HU-09 (CA-09-2) Y ALERTA (CA-09-3)
     NOTA: CODIGO SIMPLE, COMENTARIOS EN MAYUSCULA Y SIN TILDES
     ========================================================= -->
<script>
"use strict";
// OBTENER DATOS DESDE DATA-ATTRIBUTES
const metaEl = document.getElementById('meta-data');
const LB = parseFloat(metaEl?.dataset.lb || '0');
const META = parseFloat(metaEl?.dataset.meta || '0');
const ACTUAL = parseFloat(metaEl?.dataset.actual || '0');
const UMBRAL = parseFloat(metaEl?.dataset.umbral || '10');

// FUNCION AUX: FORMATEAR PORCENTAJE CON 1 DECIMAL
const pct = (x) => isFinite(x) ? (Math.round(x * 10) / 10).toFixed(1) + '%' : '‚Äî';

// CALCULO DE PROGRESO HACIA LA META
// PROGRESO = (REDUCCION LOGRADA) / (REDUCCION REQUERIDA)
let progreso = 0;
let reduccionLogradaPct = null;
let desviacionPct = null;
let cumplimientoTxt = '‚Äî';

if (LB > 0 && META >= 0) {
  const reduccionRequerida = Math.max(0, LB - META);
  const reduccionLograda = Math.max(0, LB - ACTUAL);
  progreso = reduccionRequerida > 0 ? Math.min(100, Math.max(0, (reduccionLograda / reduccionRequerida) * 100)) : 100;
  reduccionLogradaPct = LB > 0 ? Math.max(0, (reduccionLograda / LB) * 100) : null;

  // CUMPLIMIENTO: ACTUAL <= META => EN LINEA
  const enLinea = ACTUAL <= META;
  cumplimientoTxt = enLinea ? 'En linea con la meta' : 'Sobre la meta';

  // DESVIACION VS META (RELATIVA A LA META)
  if (META > 0) {
    desviacionPct = ((ACTUAL - META) / META) * 100;
  } else if (META === 0) {
    // SI LA META ES 0, CUALQUIER VALOR ACTUAL ES DESVIACION POSITIVA
    desviacionPct = ACTUAL > 0 ? 100 : 0;
  }
}

// ACTUALIZAR UI: BARRA DE PROGRESO
const bar = document.getElementById('progress-bar');
const txt = document.getElementById('progress-text');
if (bar) bar.style.width = (isFinite(progreso) ? progreso : 0) + '%';
if (txt) txt.textContent = 'Avance: ' + (isFinite(progreso) ? pct(progreso/100) : '‚Äî');

// ACTUALIZAR KPI REDUCCION LOGRADA
const elRed = document.getElementById('kpi-reduccion-lograda');
if (elRed) elRed.textContent = (reduccionLogradaPct !== null && isFinite(reduccionLogradaPct)) ? pct(reduccionLogradaPct/100) : '‚Äî';

// ACTUALIZAR KPI CUMPLIMIENTO
const elCum = document.getElementById('kpi-cumplimiento');
if (elCum) elCum.textContent = cumplimientoTxt;

// ACTUALIZAR KPI DESVIACION
const elDesv = document.getElementById('kpi-desviacion');
if (elDesv) {
  if (desviacionPct !== null && isFinite(desviacionPct)) {
    const signo = desviacionPct > 0 ? '+' : '';
    elDesv.textContent = signo + pct(desviacionPct/100);
  } else {
    elDesv.textContent = '‚Äî';
  }
}

// ALERTA AUTOMATICA SI DESVIACION SUPERA UMBRAL (CA-09-3)
const alertasAuto = document.getElementById('alertas-auto');
if (alertasAuto && desviacionPct !== null && isFinite(desviacionPct)) {
  const sobreUmbral = desviacionPct > UMBRAL;
  if (sobreUmbral) {
    const box = document.createElement('article');
    box.className = 'alert';
    box.style.borderLeft = '6px solid #d14343';
    box.style.background = '#fff';
    box.style.border = '1px solid var(--borde)';
    box.style.borderRadius = '10px';
    box.style.padding = '.8rem';
    box.style.marginTop = '.75rem';
    box.innerHTML = '<strong>Desviacion sobre umbral</strong><p style="margin:0;color:#555;">La desviacion actual es de ' + pct(desviacionPct/100) + ' y supera el umbral de ' + pct(UMBRAL/100) + ' establecido.</p>';
    alertasAuto.appendChild(box);
  }
}
</script>

<!-- Gr√°fico de tendencia de emisiones -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  "use strict";

  // Gr√°fico de tendencia de emisiones 2015‚Äì2025 con curvas
  const ctxCurvas = document.getElementById('emisionesCurvasChart').getContext('2d');
  const emisionesCurvasChart = new Chart(ctxCurvas, {
    type: 'line',
    data: {
      labels: ['2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024', '2025'],
      datasets: [{
        label: 'Emisiones (tCO2e)',
        data: [200, 190, 185, 180, 170, 160, 150, 140, 130, 120, 110],
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderWidth: 2,
        tension: 0.5, // Curvatura de las l√≠neas
      }],
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
        },
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'A√±o',
          },
        },
        y: {
          title: {
            display: true,
            text: 'tCO2e',
          },
          beginAtZero: true,
        },
      },
    },
  });
</script>
{% endblock %}
