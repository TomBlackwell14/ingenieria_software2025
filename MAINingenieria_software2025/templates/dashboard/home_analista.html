{% extends "base.html" %}
{% load static %}
{% block title %}Panel Analista Ambiental ¬∑ Cencosud Gases Free{% endblock %}
{% block page_class %}dashboard-analista{% endblock %}

{% block content %}
<!-- =========================================================
   HOME ANALISTA AMBIENTAL (HU-05/06/07/03/04 + ESCENARIOS)
   NOTA: SE MANTIENE MISMA ESTRUCTURA, IDS Y URLS
   ========================================================= -->

<!-- ========================= TOPBAR / ACCIONES ========================= -->
<header class="topbar role-analista" role="banner">
  <div class="brand">
    <a class="brand__logo" href="#" aria-label="Ir al inicio"><span class="logo">üìä</span></a>
    <div class="brand-text">
      <h1 class="brand-text__title">Cencosud <span style="color:var(--color-accent)">Gases Free</span></h1>
      <p class="brand-text__tagline">Panel del Analista Ambiental</p>
    </div>
  </div>

  <nav class="nav-links">
    <a href="#sec-carga-consumos">Carga manual</a>
    <a href="#importacion">Importar Excel</a>
    <a href="#inventario">Inventario</a>
    <a href="#exportar">Exportar</a>
    <a href="#simulacion">Simulaci√≥n</a>
  </nav>

  <div class="actions">
    <a class="btn btn--ghost" href="{% url 'role_login' %}">Cambiar rol</a>
    <a class="btn btn--primary" href="{% url 'role_login' %}">Cerrar sesi√≥n</a>
  </div>
</header>

<!-- ========================= CONTENIDO PRINCIPAL ========================= -->
<main class="dashboard-analista container">

  <!-- ============== KPIS RAPIDOS (VALORES DEMO SI NO HAY CONTEXTO) ============== -->
  <section id="resumen" class="overview">
    <div class="card kpi"><h4>Emisiones totales (tCO2e)</h4><strong>{{ kpi_total|default:"12.480" }}</strong></div>
    <div class="card kpi"><h4>Meta anual cumplida</h4><strong>{{ kpi_meta|default:"82%" }}</strong></div>
    <div class="card kpi"><h4>Iniciativas activas</h4><strong>{{ kpi_iniciativas|default:"17" }}</strong></div>
    <div class="card kpi"><h4>Auditor√≠as pendientes</h4><strong>{{ kpi_auditorias|default:"3" }}</strong></div>
  </section>
<!-- =========================================================
     HU-05: FORMULARIO DE CARGA MANUAL (DEMO GHG)
     - VALIDACION LOCAL + ENVIO SIMULADO
     - CONVERSION DEMO (CANTIDAD √ó FACTOR)
     ========================================================= -->
<section class="card card--accent" id="sec-carga-consumos">
  <header class="section-head">
    <div class="head-left">
      <h3>üì• Registro de Consumos (Demo GHG)</h3>
      <small>Geolocalizaci√≥n din√°mica + Alcance/Consumo/Cantidad + Conversi√≥n simulada</small>
    </div>
    <div class="head-right"><span class="badge">HU-05</span></div>
  </header>

  <!-- NOTA: PROTOTIPO (NO SE ENVIA REALMENTE) -->
  <form id="frm-ghg" class="grid form-grid" method="post" novalidate>
    {% csrf_token %}

    <!-- ---------- 1) GEOLOCALIZACION DINAMICA ---------- -->
    <div class="fieldset">
      <div class="fieldset__legend">1) Geolocalizaci√≥n</div>
      <div class="fieldset__grid">
        <!-- PAIS -->
        <div class="form-field">
          <label for="pais">Pa√≠s</label>
          <select id="pais" name="pais" required>
            <option value="" selected disabled>Seleccione‚Ä¶</option>
            <option value="CL">Chile</option>
            <option value="PE">Per√∫</option>
            <option value="CO">Colombia</option>
            <option value="AR">Argentina</option>
            <option value="BR">Brasil</option>
          </select>
        </div>

        <!-- REGION/PROVINCIA DINAMICO PARA CHILE/ARGENTINA -->
        <div class="form-field" id="box-region" hidden>
          <label for="region">Regi√≥n / Provincia</label>
          <select id="region" name="region"></select>
        </div>

        <!-- CAMPO LIBRE PARA OTROS PAISES -->
        <div class="form-field" id="box-depto" hidden>
          <label for="depto">Departamento / Estado</label>
          <input id="depto" name="depto" type="text" placeholder="Escriba departamento/estado">
        </div>
      </div>
    </div>

    <!-- ---------- 2) ALCANCE / CONSUMO / CANTIDAD ---------- -->
    <div class="fieldset">
      <div class="fieldset__legend">2) Alcance y Consumo</div>
      <div class="fieldset__grid">
        <!-- ALCANCE -->
        <div class="form-field">
          <label for="alcance">Alcance (GHG)</label>
          <select id="alcance" name="alcance" required>
            <option value="" selected disabled>Seleccione‚Ä¶</option>
            <option value="1">Alcance 1</option>
            <option value="2">Alcance 2</option>
            <option value="3">Alcance 3</option>
          </select>
        </div>

        <!-- CONSUMO (DEPENDIENTE DEL ALCANCE) -->
        <div class="form-field">
          <label for="consumo">Tipo de consumo</label>
          <select id="consumo" name="consumo" required disabled>
            <option value="" selected disabled>Seleccione alcance primero‚Ä¶</option>
          </select>
          <small class="muted">Lista adaptada a retail y protocolo GHG</small>
        </div>

        <!-- CANTIDAD -->
        <div class="form-field">
          <label for="cantidad">Cantidad</label>
          <input id="cantidad" name="cantidad" type="number" min="0" step="0.0001" placeholder="0.0000" required>
          <small class="muted">Unidad seg√∫n consumo (ej: L, kWh, kg, t¬∑km)</small>
        </div>
      </div>
    </div>

    <!-- ---------- 3) ACCIONES Y PREVIEW ---------- -->
    <div class="fieldset">
      <div class="fieldset__legend">3) Acciones</div>
      <div class="fieldset__grid">
        <!-- BOTONES ACCION -->
        <div class="form-field" style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" id="btn-validar" class="btn">Validar</button>
          <button type="button" id="btn-probar" class="btn btn--secondary">Probar conversi√≥n</button>
          <button type="submit" id="btn-enviar" class="btn btn--primary">Enviar (servidor)</button>
        </div>

        <!-- MENSAJES -->
        <div class="form-field" style="grid-column:1/-1">
          <div id="msg" class="card" style="padding:10px; background:#fff; border-left:4px solid #d1d5db; margin-bottom:8px;">
            <strong>Estado:</strong> <span id="msg-text">Sin datos</span>
          </div>
          <div id="conv" class="card" style="padding:10px; background:#f8fafc; border-left:4px solid #60a5fa;">
            <strong>Conversi√≥n (demo):</strong> <span id="conv-text">‚Äî</span>
          </div>
          <div style="margin-top:6px">
            <small class="muted">
              Nota: factores de emisi√≥n <em>de ejemplo</em> para la demo (no oficiales).
            </small>
          </div>
        </div>
      </div>
    </div>
  </form>
</section>

  <!-- =========================================================
       HU-06: IMPORTAR EXCEL (SUBIDA + PLANTILLAS)
       ========================================================= -->
  <section id="importacion" class="card">
    <header class="section-head">
      <div class="head-left">
        <h3>üìë Importar archivo Excel</h3>
        <small>Formato: [fecha, tipo_consumo, unidad, cantidad, pa√≠s, unidad_negocio, detalle]</small>
      </div>
      <div class="head-right"><span class="badge">HU-06</span></div>
    </header>

    <div class="import-grid">
      <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:analista_importar_excel' %}">
        {% csrf_token %}
        <input type="file" name="archivo" accept=".xlsx,.xls" required>
        <button type="submit" class="btn btn--primary">Subir e importar</button>
      </form>

      <div class="template-help">
        <p><strong>Plantilla de ejemplo:</strong></p>
        <div class="btn-row">
          <a class="btn btn--ghost" href="{% url 'dashboard:analista_descargar_plantilla' 'xlsx' %}">Descargar XLSX</a>
          <a class="btn btn--ghost" href="{% url 'dashboard:analista_descargar_plantilla' 'csv' %}">Descargar CSV</a>
        </div>
        <small class="muted">Las filas inv√°lidas se reportar√°n en un log.</small>
      </div>
    </div>
  </section>

  <!-- =========================================================
       HU-03: INVENTARIO CONSOLIDADO (FILTROS + TABLA + CHART)
       ========================================================= -->
  <section id="inventario" class="card">
    <header class="section-head">
      <div class="head-left">
        <h3>üìö Inventario consolidado GEI</h3>
        <small>Filtros por a√±o, alcance, fuente, unidad de negocio</small>
      </div>
      <div class="head-right"><span class="badge">HU-03</span></div>
    </header>

    <!-- ---------- FILTROS ---------- -->
    <form class="filters" method="get" action="{% url 'dashboard:analista_inventario' %}">
      <div class="filter-row">
        <select name="anio">
          <option value="">A√±o (todos)</option>
          {% for y in anios %}
            <option value="{{ y }}" {% if request.GET.anio == y|stringformat:'s' %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>

        <select name="alcance">
          <option value="">Alcance (todos)</option>
          <option value="1" {% if request.GET.alcance == '1' %}selected{% endif %}>Alcance 1</option>
          <option value="2" {% if request.GET.alcance == '2' %}selected{% endif %}>Alcance 2</option>
          <option value="3" {% if request.GET.alcance == '3' %}selected{% endif %}>Alcance 3</option>
        </select>

        <select name="fuente">
          <option value="">Fuente (todas)</option>
          <option value="combustible" {% if request.GET.fuente == 'combustible' %}selected{% endif %}>Combustible</option>
          <option value="electricidad" {% if request.GET.fuente == 'electricidad' %}selected{% endif %}>Electricidad</option>
          <option value="refrigerantes" {% if request.GET.fuente == 'refrigerantes' %}selected{% endif %}>Refrigerantes</option>
        </select>

        <select name="unidad_negocio">
          <option value="">Unidad negocio (todas)</option>
          {% for u in unidades_negocio %}
            <option value="{{ u.id }}" {% if request.GET.unidad_negocio == u.id|stringformat:'s' %}selected{% endif %}>{{ u.nombre }}</option>
          {% endfor %}
        </select>

        <button class="btn btn--ghost" type="submit">Aplicar filtros</button>
      </div>
    </form>

    <!-- ---------- GRAFICO: EMISIONES HISTORICAS ---------- -->
    <div class="card" style="margin:12px 0;">
      <header class="section-head">
        <div class="head-left">
          <h3>üìà Emisiones hist√≥ricas (tCO2e)</h3>
          <small>Fuente: inventario consolidado (tras filtros)</small>
        </div>
      </header>

      <div style="padding:12px;">
        <canvas id="chartEmisiones" height="90"></canvas>
        {% if not series_anios %}
          <div class="empty" style="margin-top:8px;">Sin datos para graficar</div>
        {% endif %}
      </div>
    </div>

    <!-- ---------- TABLA INVENTARIO ---------- -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Alcance</th>
            <th>Fuente</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>tCO2e</th>
            <th>Pa√≠s</th>
            <th>Unidad negocio</th>
          </tr>
        </thead>
        <tbody>
          {% for r in inventario %}
            <tr>
              <td>{{ r.fecha|date:"Y-m-d" }}</td>
              <td>{{ r.alcance }}</td>
              <td>{{ r.fuente }}</td>
              <td>{{ r.unidad }}</td>
              <td>{{ r.cantidad }}</td>
              <td><strong>{{ r.tco2e }}</strong></td>
              <td>{{ r.pais }}</td>
              <td>{{ r.unidad_negocio__nombre|default:r.unidad_negocio }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="8" class="empty">Sin resultados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ---------- PAGINACION ---------- -->
    {% if page_obj %}
      <div class="pagination">
        {% if page_obj.has_previous %}
          <a class="btn btn--ghost" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}
        <span>P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="btn btn--ghost" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
        {% endif %}
      </div>
    {% endif %}
  </section>

  <!-- =========================================================
       HU-04: EXPORTAR INVENTARIO (CSV / XLSX / JSON + BITACORA)
       ========================================================= -->
  <section id="exportar" class="card">
    <header class="section-head">
      <div class="head-left">
        <h3>‚§µÔ∏è Exportar inventario</h3>
        <small>Archivos para auditor√≠a o an√°lisis externo</small>
      </div>
      <div class="head-right"><span class="badge">HU-04</span></div>
    </header>

    <div class="btn-row">
      <a class="btn btn--ghost" href="{% url 'dashboard:analista_exportar' 'csv' %}?{{ request.GET.urlencode }}">CSV</a>
      <a class="btn btn--ghost" href="{% url 'dashboard:analista_exportar' 'xlsx' %}?{{ request.GET.urlencode }}">XLSX</a>
      <a class="btn btn--ghost" href="{% url 'dashboard:analista_exportar' 'json' %}?{{ request.GET.urlencode }}">JSON</a>
      <a class="btn btn--primary" href="{% url 'dashboard:analista_bitacora' %}">Ver bit√°cora</a>
    </div>
  </section>

  <!-- =========================================================
       ESCENARIOS: SIMULACION DE POLITICAS PUBLICAS
       ========================================================= -->
  <section id="simulacion" class="card">
    <header class="section-head">
      <div class="head-left">
        <h3>üß™ Simulaci√≥n de pol√≠ticas p√∫blicas</h3>
        <small>Aplicar l√≠mites, impuestos al carbono o metas de reducci√≥n</small>
      </div>
      <div class="head-right"><span class="badge">Escenarios</span></div>
    </header>

    <form class="grid form-grid" method="post" action="{% url 'dashboard:analista_simulacion' %}">
      {% csrf_token %}
      <div class="form-field">
        <label for="anio_base">A√±o base</label>
        <select id="anio_base" name="anio_base" required>
          {% for y in anios %}<option value="{{ y }}">{{ y }}</option>{% endfor %}
        </select>
      </div>

      <div class="form-field">
        <label for="tipo_politica">Tipo de pol√≠tica</label>
        <select id="tipo_politica" name="tipo_politica" required>
          <option value="" disabled selected>Seleccione‚Ä¶</option>
          <option value="limite">L√≠mite de emisiones (tCO2e)</option>
          <option value="impuesto">Impuesto al carbono (USD/tCO2e)</option>
          <option value="meta_reduccion">% reducci√≥n vs a√±o base</option>
        </select>
      </div>

      <div class="form-field">
        <label for="valor_politica">Valor</label>
        <input id="valor_politica" name="valor_politica" type="number" min="0" step="0.01" placeholder="0.00" required>
      </div>

      <div class="form-field">
        <label for="ambito">√Åmbito</label>
        <select id="ambito" name="ambito" required>
          <option value="total">Total compa√±√≠a</option>
          <option value="alcance1">Solo alcance 1</option>
          <option value="alcance2">Solo alcance 2</option>
          <option value="alcance3">Solo alcance 3</option>
          <option value="por_unidad">Por unidad de negocio</option>
        </select>
      </div>

      <div class="form-actions">
        <button class="btn btn--primary" type="submit">Simular</button>
        <a class="btn btn--ghost" href="{% url 'dashboard:analista_simulacion_historial' %}">Ver escenarios previos</a>
      </div>
    </form>

    {% if simulacion %}
      <div class="sim-result">
        <h4>Resultado (preview)</h4>
        <ul>
          <li>Emisiones base: <strong>{{ simulacion.base_tco2e }}</strong> tCO2e</li>
          <li>Emisiones simuladas: <strong>{{ simulacion.sim_tco2e }}</strong> tCO2e</li>
          <li>Diferencia: <strong>{{ simulacion.delta_tco2e }}</strong> tCO2e</li>
          {% if simulacion.costo_est %}<li>Costo estimado: <strong>USD {{ simulacion.costo_est }}</strong></li>{% endif %}
        </ul>
      </div>
    {% endif %}
  </section>

</main>

<!-- =========================================================
     ESTILOS LIGEROS (LOOK OPERADOR)
     NOTA: SE MANTIENE EXACTAMENTE EL MISMO CSS
     ========================================================= -->
<style>
  .dashboard-analista .overview { display:grid; grid-template-columns:repeat(4,minmax(180px,1fr)); gap:12px; margin-bottom:16px; }
  .dashboard-analista .kpi strong { font-size:1.4rem; }

  .card { border:1px solid #e6e8eb; border-radius:12px; padding:14px; background:#fff; margin-bottom:14px; }
  .card--accent { border-color:#dfeee6; background:linear-gradient(180deg,#f7fbf9,#ffffff); }

  .section-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .section-head .badge { background:#eaf7f1; border:1px solid #cfe9dc; padding:2px 8px; border-radius:999px; font-size:.75rem; color:#1b7f52; }

  .fieldset { border:1px solid #e8edf1; border-radius:10px; padding:10px; margin-bottom:10px; background:#fafcfd; }
  .fieldset__legend { font-weight:600; margin-bottom:8px; color:#2c3e50; }
  .fieldset__grid { display:grid; grid-template-columns:repeat(4,minmax(200px,1fr)); gap:10px; }

  .preview-grid { grid-template-columns:repeat(2,minmax(260px,1fr)); }
  .form-grid { display:grid; grid-template-columns:1fr; gap:12px; }
  .form-field { display:flex; flex-direction:column; gap:6px; }
  .form-actions { display:flex; gap:8px; justify-content:flex-end; }

  .table-wrap { overflow:auto; border:1px solid #e5e7eb; border-radius:10px; }
  table { width:100%; border-collapse:collapse; }
  thead th { background:#f8faf9; text-align:left; padding:10px; border-bottom:1px solid #e5e7eb; }
  tbody td { padding:10px; border-bottom:1px solid #eef1f3; }
  .empty { text-align:center; color:#888; }
  .btn-row { display:flex; gap:8px; flex-wrap:wrap; }

  @media (max-width:1100px){
    .fieldset__grid{grid-template-columns:repeat(2,1fr);}
    .overview{grid-template-columns:repeat(2,1fr);}
  }
  @media (max-width:680px){
    .fieldset__grid,.preview-grid{grid-template-columns:1fr;}
  }
</style>
<script>
  "use strict";
  // ============================================================
  // UTILIDADES Y DATOS DE APOYO
  // COMENTARIOS EN MAYUSCULA Y SIN TILDES
  // ============================================================
  const $ = (sel) => document.querySelector(sel);

  // REGIONES DE CHILE Y ARGENTINA (LISTA RESUMIDA)
  const REGIONES_CL = ["Arica y Parinacota","Tarapac√°","Antofagasta","Atacama","Coquimbo","Valpara√≠so","Metropolitana de Santiago","O‚ÄôHiggins","Maule","√ëuble","Biob√≠o","La Araucan√≠a","Los R√≠os","Los Lagos","Ays√©n","Magallanes"];
  const PROVINCIAS_AR = ["Buenos Aires","Catamarca","Chaco","Chubut","C√≥rdoba","Corrientes","Entre R√≠os","Formosa","Jujuy","La Pampa","La Rioja","Mendoza","Misiones","Neuqu√©n","R√≠o Negro","Salta","San Juan","San Luis","Santa Cruz","Santa Fe","Santiago del Estero","Tierra del Fuego","Tucum√°n"];

  // CONSUMOS SEGUN ALCANCE (DEMO)
  const CONSUMOS = {
    "1": ["Diesel (L)", "Nafta/Gasolina (L)", "Gas Natural (m¬≥)"],
    "2": ["Electricidad (kWh)", "Vapor (ton)", "Refrigerantes (kg)"],
    "3": ["Logistica t¬∑km", "Viajes aereos (km)", "Residuos (kg)"]
  };

  // FACTORES DEMO (KG CO2E POR UNIDAD) ‚Äî VALORES ILUSTRATIVOS
  const FACTORES = {
    "Diesel (L)": 2.68,
    "Nafta/Gasolina (L)": 2.31,
    "Gas Natural (m¬≥)": 1.90,
    "Electricidad (kWh)": 0.45,
    "Vapor (ton)": 50.0,
    "Refrigerantes (kg)": 1300.0,
    "Logistica t¬∑km": 0.06,
    "Viajes aereos (km)": 0.15,
    "Residuos (kg)": 0.50
  };

  // ELEMENTOS
  const frm        = $("#frm-ghg");
  const pais       = $("#pais");
  const boxRegion  = $("#box-region");
  const region     = $("#region");
  const boxDepto   = $("#box-depto");
  const depto      = $("#depto");
  const alcance    = $("#alcance");
  const consumo    = $("#consumo");
  const cantidad   = $("#cantidad");
  const btnValidar = $("#btn-validar");
  const btnEnviar  = $("#btn-enviar");
  const btnProbar  = $("#btn-probar");
  const msg        = $("#msg");
  const msgText    = $("#msg-text");
  const convText   = $("#conv-text");

  // ============================================================
  // GEOLOGICA DINAMICA
  // ============================================================
  function toggleGeo(p) {
    region.innerHTML = "";
    depto.value = "";
    boxRegion.hidden = true;
    boxDepto.hidden  = true;

    if (p === "CL") {
      boxRegion.hidden = false;
      const opts = REGIONES_CL.map(r => `<option value="${r}">${r}</option>`).join("");
      region.innerHTML = `<option value="" selected disabled>Seleccione‚Ä¶</option>${opts}`;
    } else if (p === "AR") {
      boxRegion.hidden = false;
      const opts = PROVINCIAS_AR.map(r => `<option value="${r}">${r}</option>`).join("");
      region.innerHTML = `<option value="" selected disabled>Seleccione‚Ä¶</option>${opts}`;
    } else if (p) {
      boxDepto.hidden = false;
    }
  }
  pais.addEventListener("change", (e) => toggleGeo(e.target.value));

  // ============================================================
  // CARGA DE CONSUMOS SEGUN ALCANCE
  // ============================================================
  alcance.addEventListener("change", (e) => {
    const val = e.target.value;
    consumo.disabled = true;
    consumo.innerHTML = `<option value="" selected disabled>Cargando‚Ä¶</option>`;
    if (CONSUMOS[val]) {
      const opts = CONSUMOS[val].map(c => `<option value="${c}">${c}</option>`).join("");
      consumo.innerHTML = `<option value="" selected disabled>Seleccione‚Ä¶</option>${opts}`;
      consumo.disabled = false;
    } else {
      consumo.innerHTML = `<option value="" selected disabled>Seleccione alcance primero‚Ä¶</option>`;
    }
    // LIMPIA CONVERSION CUANDO CAMBIA ALCANCE
    convText.textContent = "‚Äî";
  });

  // ============================================================
  // VALIDACION LOCAL
  // ============================================================
  function validarFormulario() {
    let ok = true;

    if (!pais.value) ok = false;

    if (pais.value === "CL" || pais.value === "AR") {
      if (boxRegion.hidden || !region.value) ok = false;
    } else if (pais.value) {
      const hasLetters = /[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±]/.test((depto.value || "").trim());
      if (boxDepto.hidden || !depto.value.trim() || !hasLetters) ok = false;
    }

    if (!alcance.value) ok = false;
    if (consumo.disabled || !consumo.value) ok = false;

    const qty = parseFloat(cantidad.value);
    if (isNaN(qty) || qty <= 0) ok = false;

    return ok;
  }

  function setMsgOk(text) {
    msg.style.background = "#f7fdf9";
    msg.style.borderLeft = "4px solid #16a34a";
    msgText.textContent = text;
  }
  function setMsgErr(text) {
    msg.style.background = "#fff7f7";
    msg.style.borderLeft = "4px solid #dc2626";
    msgText.textContent = text;
  }

  // ============================================================
  // BOTON VALIDAR
  // ============================================================
  btnValidar.addEventListener("click", () => {
    const ok = validarFormulario();
    if (ok) setMsgOk("GUARDADO CORRECTAMENTE");
    else setMsgErr("ERROR EN EL INGRESO DE DATOS");
  });

  // ============================================================
  // BOTON PROBAR CONVERSION (DEMO)
  // ============================================================
  btnProbar.addEventListener("click", () => {
    const c = consumo.value;
    const qty = parseFloat(cantidad.value);
    if (!c || isNaN(qty) || qty <= 0) {
      setMsgErr("Complete consumo y una cantidad mayor a 0 para convertir");
      convText.textContent = "‚Äî";
      return;
    }
    const factor = FACTORES[c];
    if (!factor) {
      setMsgErr("No hay factor demo configurado para este consumo");
      convText.textContent = "‚Äî";
      return;
    }
    const result = +(qty * factor).toFixed(4);
    convText.textContent = `${qty} √ó ${factor} = ${result} kg CO2e`;
    // MENSAJE INFORMATIVO (NO ERROR)
    msg.style.background = "#fff";
    msg.style.borderLeft = "4px solid #d1d5db";
    msgText.textContent = "Conversi√≥n realizada (demo)";
  });

  // ============================================================
  // ENVIO SIMULADO (REQUIERE VALIDACION OK)
  // ============================================================
  frm.addEventListener("submit", (e) => {
    e.preventDefault(); // PROTOTIPO: NO ENVIA AL BACKEND
    const ok = validarFormulario();
    if (!ok) {
      setMsgErr("Revisar datos antes de enviar");
      return;
    }
    setMsgOk("Datos enviados (simulado). Gracias.");
  });
</script>

{% endblock %}