{% extends "base.html" %}
{% load static %}
{% block title %}Panel Analista Ambiental ¬∑ Cencosud Gases Free{% endblock %}
{% block page_class %}dashboard-analista{% endblock %}

{% block content %}
<!-- =========================================================
  HOME ANALISTA AMBIENTAL (CARGA MANUAL ESTILO OPERADOR + HU-06/07/03/04)
  ========================================================= -->

<header class="topbar role-analista" role="banner">
  <div class="brand">
    <a class="brand__logo" href="#" aria-label="Ir al inicio"><span class="logo">üìä</span></a>
    <div class="brand-text">
      <h1 class="brand-text__title">Cencosud <span style="color:var(--color-accent)">Gases Free</span></h1>
      <p class="brand-text__tagline">Panel del Analista Ambiental</p>
    </div>
  </div>

  <nav class="nav-links">
    <a href="#carga-manual">Carga manual</a>
    <a href="#importacion">Importar Excel</a>
    <a href="#inventario">Inventario</a>
    <a href="#exportar">Exportar</a>
    <a href="#simulacion">Simulaci√≥n</a>
  </nav>

  <div class="actions">
    <a class="btn btn--ghost" href="{% url 'role_login' %}">Cambiar rol</a>
    <a class="btn btn--primary" href="{% url 'role_login' %}">Cerrar sesi√≥n</a>
  </div>
</header>

<main class="dashboard-analista container">

  <!-- ===== KPIs R√ÅPIDOS -->
  <section id="resumen" class="overview">
    <div class="card kpi"><h4>Emisiones totales (tCO2e)</h4><strong>{{ kpi_total|default:"12.480" }}</strong></div>
    <div class="card kpi"><h4>Meta anual cumplida</h4><strong>{{ kpi_meta|default:"82%" }}</strong></div>
    <div class="card kpi"><h4>Iniciativas activas</h4><strong>{{ kpi_iniciativas|default:"17" }}</strong></div>
    <div class="card kpi"><h4>Auditor√≠as pendientes</h4><strong>{{ kpi_auditorias|default:"3" }}</strong></div>
  </section>

{# ============================== #}
{# CARGA MANUAL (DEMO MEJORADO)  #}
{# ============================== #}
<section id="carga-manual" class="card card--accent">
  <header class="section-head">
    <div class="head-left">
      <h3>üì• Carga manual de consumos</h3>
      <small><b>DEMO:</b> Calculo SIMULADO en cliente. El oficial se haria en servidor.</small>
    </div>
    <div class="head-right">
      <span class="badge">HU-A1 ¬∑ HU-A2</span>
    </div>
  </header>

  <form id="form-carga-manual" class="grid form-grid operador-form" method="post" action="#">
    {% csrf_token %}

    <!-- PASO 1: CONTEXTO -->
    <div class="fieldset">
      <div class="fieldset__legend">1) Contexto</div>
      <div class="fieldset__grid">
        <div class="form-field">
          <label for="fecha">Fecha</label>
          <input id="fecha" name="fecha" type="date" required>
        </div>

        {# PAIS Y UNIDAD DE NEGOCIO AUTO EN LA MISMA FILA #}
        <div class="form-field">
          <label for="pais">Pais</label>
          <select id="pais" name="pais" required>
            <option value="" selected disabled>Seleccione‚Ä¶</option>
            <option value="CL">Chile</option>
            <option value="AR">Argentina</option>
            <option value="BR">Brasil</option>
            <option value="PE">Peru</option>
            <option value="CO">Colombia</option>
            <option value="UY">Uruguay</option>
          </select>
        </div>

        <div class="form-field">
          <label>Unidad de negocio (auto)</label>
          <input id="unidad_negocio_nombre" type="text" value="-" disabled>
          <input id="unidad_negocio" name="unidad_negocio" type="hidden" value="">
          <small class="muted">Se asigna automaticamente segun pais (DEMO).</small>
        </div>
      </div>
    </div>

    <!-- PASO 2: ALCANCE, FUENTE Y UNIDAD -->
    <div class="fieldset">
      <div class="fieldset__legend">2) Alcance y fuente</div>
      <div class="fieldset__grid">
        <div class="form-field">
          <label for="alcance">Alcance</label>
          <select id="alcance" name="alcance" required>
            <option value="" selected disabled>Seleccione‚Ä¶</option>
            <option value="1">Alcance 1</option>
            <option value="2">Alcance 2</option>
            <option value="3">Alcance 3</option>
          </select>
          <small class="muted">Cambia opciones segun alcance.</small>
        </div>

        <div class="form-field">
          <label for="tipo_consumo">Tipo de consumo</label>
          <select id="tipo_consumo" name="tipo_consumo" required>
            <option value="" selected disabled>Seleccione‚Ä¶</option>
            {# SE RELLENA DINAMICAMENTE SEGUN ALCANCE #}
          </select>
        </div>

        <div class="form-field only-combustible" hidden>
          <label for="tipo_combustible">Tipo de combustible</label>
          <select id="tipo_combustible" name="tipo_combustible">
            <option value="" selected disabled>Seleccione‚Ä¶</option>
            {# OPCIONES CAMBIAN CON ALCANCE=1 Y TIPO=COMBUSTIBLE #}
          </select>
        </div>

        <div class="form-field">
          <label for="unidad">Unidad</label>
          <select id="unidad" name="unidad" required>
            <option value="" selected disabled>Seleccione‚Ä¶</option>
            {# UNIDADES SUGERIDAS SEGUN FUENTE/ALCANCE #}
          </select>
        </div>

        <div class="form-field">
          <label for="cantidad">Cantidad</label>
          <input id="cantidad" name="cantidad" type="number" min="0" step="0.0001" placeholder="0.0000" required>
        </div>
      </div>
    </div>

    <!-- PASO 3: PREVIEW GHG -->
    <div class="fieldset">
      <div class="fieldset__legend">3) Vista previa GHG (SIMULADO)</div>
      <div class="fieldset__grid preview-grid">
        <div class="form-field">
          <label>Factor de emision (preview)</label>
          <input id="factor_preview" type="text" value="-" disabled>
          <small class="muted">tCO2e por unidad (segun pais y fuente).</small>
        </div>
        <div class="form-field">
          <label>tCO2e (preview)</label>
          <input id="tco2e_preview" type="text" value="-" disabled>
        </div>
      </div>
    </div>

    <!-- ACCIONES -->
    <div class="form-actions">
      <button id="btn-guardar-demo" type="submit" class="btn btn--primary">Guardar registro (DEMO)</button>
      <button type="reset" class="btn btn--ghost">Limpiar</button>
    </div>

    <div id="toast-demo" class="toast" hidden>‚úÖ Registro creado (SIMULADO).</div>
  </form>
</section>

<style>
/* ESTILOS MINIMOS DE APOYO DEMO */
.toast{background:#eaf7f1;border:1px solid #cfe9dc;padding:8px 12px;border-radius:8px;margin-top:8px;color:#1b7f52;}
</style>

<script>
/* ============================================================
  COMENTARIOS EN MAYUSCULAS Y SIN TILDES
  LOGICA DEMO: SIN PERSISTENCIA, SOLO PREVIEW Y TOAST
   ============================================================ */

/* MAPEO DEMO DE UNIDAD DE NEGOCIO POR PAIS (NOMBRE + ID) */
const DEFAULT_UN = {
  CL: { id: "CL-01", nombre: "Sede Santiago" },
  AR: { id: "AR-01", nombre: "Sede Buenos Aires" },
  BR: { id: "BR-01", nombre: "Sede Sao Paulo" },
  PE: { id: "PE-01", nombre: "Sede Lima" },
  CO: { id: "CO-01", nombre: "Sede Bogota" },
  UY: { id: "UY-01", nombre: "Sede Montevideo" },
};

/* FACTORES DEMO EN tCO2e POR UNIDAD (APROX) */
const FX_DEMO = {
  /* ALCANCE 1: COMBUSTIBLES (FACTORES POR UNIDAD) */
  combustible: {
    diesel:   { l: 0.00268, kg: 0.00316, m3: 2.68 }, // DEMO
    gasolina: { l: 0.00231, kg: 0.00300, m3: 2.31 }, // DEMO
    gnl:      { kg: 0.00275, m3: 0.00190 },          // DEMO
    glp:      { kg: 0.00300, l: 0.00150 },           // DEMO
  },
  /* ALCANCE 2: ELECTRICIDAD POR PAIS (tCO2e/kWh) */
  electricidad: {
    CL: { kwh: 0.000393 }, // DEMO: ~0.393 t/MWh
    AR: { kwh: 0.000400 },
    BR: { kwh: 0.000100 },
    PE: { kwh: 0.000300 },
    CO: { kwh: 0.000250 },
    UY: { kwh: 0.000200 },
  },
  /* ALCANCE 3: GENERICO DEMO (POR DEFECTO 1.0 tCO2e/UNIDAD SI KG) */
  alcance3: {
    kg: 1.0
  }
};

/* OPCIONES DEPENDIENTES POR ALCANCE (DEMO) */
const OPTIONS = {
  alcance1: {
    tipoConsumo: [
      {v:"combustible", t:"Combustible"},
      {v:"refrigerantes", t:"Refrigerantes"}
    ],
    combustibles: [
      {v:"diesel", t:"Diesel"},
      {v:"gasolina", t:"Gasolina"},
      {v:"gnl", t:"GNL"},
      {v:"glp", t:"GLP"},
    ],
    unidades: ["l","kg","m3"]
  },
  alcance2: {
    tipoConsumo: [
      {v:"electricidad", t:"Electricidad"}
    ],
    combustibles: [],
    unidades: ["kwh"]
  },
  alcance3: {
    tipoConsumo: [
      {v:"otros", t:"Otros (Alcance 3)"}
    ],
    combustibles: [],
    unidades: ["kg"]
  }
};

/* GETTERS DE ELEMENTOS */
const $alcance    = document.getElementById('alcance');
const $pais       = document.getElementById('pais');
const $unNombre   = document.getElementById('unidad_negocio_nombre');
const $unHidden   = document.getElementById('unidad_negocio');
const $tipoCons   = document.getElementById('tipo_consumo');
const $tipoComb   = document.getElementById('tipo_combustible');
const $unidad     = document.getElementById('unidad');
const $cantidad   = document.getElementById('cantidad');
const $fxPrev     = document.getElementById('factor_preview');
const $tPrev      = document.getElementById('tco2e_preview');
const $onlyComb   = document.querySelector('.only-combustible');
const $form       = document.getElementById('form-carga-manual');
const $toast      = document.getElementById('toast-demo');

/* ASIGNAR UNIDAD DE NEGOCIO AUTOMATICA SEGUN PAIS */
function setUNPorPais(){
  const p = $pais.value;
  const un = DEFAULT_UN[p];
  if (un){
    $unNombre.value = un.nombre;
    $unHidden.value = un.id;
  } else {
    $unNombre.value = "-";
    $unHidden.value = "";
  }
}

/* RELLENAR SELECTS SEGUN ALCANCE */
function refreshPorAlcance(){
  const a = $alcance.value;
  let conf = null;
  if (a === "1") conf = OPTIONS.alcance1;
  else if (a === "2") conf = OPTIONS.alcance2;
  else if (a === "3") conf = OPTIONS.alcance3;

  // TIPOS DE CONSUMO
  $tipoCons.innerHTML = '<option value="" selected disabled>Seleccione‚Ä¶</option>';
  (conf?.tipoConsumo || []).forEach(o=>{
    const opt = document.createElement('option');
    opt.value = o.v; opt.textContent = o.t;
    $tipoCons.appendChild(opt);
  });

  // COMBUSTIBLES
  $onlyComb.hidden = !(a === "1");
  $tipoComb.innerHTML = '<option value="" selected disabled>Seleccione‚Ä¶</option>';
  (conf?.combustibles || []).forEach(o=>{
    const opt = document.createElement('option');
    opt.value = o.v; opt.textContent = o.t;
    $tipoComb.appendChild(opt);
  });

  // UNIDADES
  $unidad.innerHTML = '<option value="" selected disabled>Seleccione‚Ä¶</option>';
  (conf?.unidades || []).forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u; opt.textContent = u.toUpperCase();
    $unidad.appendChild(opt);
  });

  calcPreview();
}

/* OBTENER FACTOR DEMO */
function getFactor(){
  const a  = $alcance.value;
  const pa = $pais.value;
  const tc = $tipoCons.value;
  const u  = ($unidad.value||'').toLowerCase();
  if (!a || !tc || !u) return null;

  // ALCANCE 1 - COMBUSTIBLES O REFRIGERANTES
  if (a === "1"){
    if (tc === "combustible"){
      const t = $tipoComb.value || "diesel";
      const tbl = (FX_DEMO.combustible[t]||{});
      return tbl[u] || null;
    }
    if (tc === "refrigerantes"){
      // DEMO: 1.0 tCO2e POR KG
      return (u === "kg") ? 1.0 : null;
    }
  }

  // ALCANCE 2 - ELECTRICIDAD POR PAIS
  if (a === "2" && tc === "electricidad"){
    const tbl = FX_DEMO.electricidad[pa] || {};
    return tbl[u] || null;
  }

  // ALCANCE 3 - GENERICO
  if (a === "3"){
    const v = FX_DEMO.alcance3[u];
    return v || null;
  }

  return null;
}

/* CALCULAR PREVIEW */
function calcPreview(){
  const f = getFactor();
  const v = parseFloat($cantidad.value || "0") || 0;
  if (f && v >= 0){
    $fxPrev.value = f.toFixed(6) + ' tCO2e/' + ($unidad.value || '-');
    const t = v * f;
    $tPrev.value  = t.toFixed(3) + ' tCO2e';
  } else {
    $fxPrev.value = '-';
    $tPrev.value  = '-';
  }
}

/* TOAST DEMO */
function showToast(msg){
  $toast.textContent = msg || '‚úÖ Operacion simulada.';
  $toast.hidden = false;
  setTimeout(()=>{ $toast.hidden = true; }, 1800);
}

/* EVENTOS */
$pais?.addEventListener('change', ()=>{ setUNPorPais(); calcPreview(); });
$alcance?.addEventListener('change', ()=>{ refreshPorAlcance(); });
$tipoCons?.addEventListener('change', calcPreview);
$tipoComb?.addEventListener('change', calcPreview);
$unidad?.addEventListener('change', calcPreview);
$cantidad?.addEventListener('input', calcPreview);

/* INTERCEPTAR SUBMIT PARA DEMO */
$form?.addEventListener('submit', (e)=>{
  e.preventDefault(); // DEMO: NO ENVIA
  calcPreview();
  showToast('‚úÖ Registro creado (SIMULADO).');
});

/* INIT */
setUNPorPais();
refreshPorAlcance();
calcPreview();
</script>


  <!-- =========================================================
    HU-06: IMPORTAR EXCEL
    ========================================================= -->
  <section id="importacion" class="card">
    <header class="section-head">
      <div class="head-left">
        <h3>üìë Importar archivo Excel</h3>
        <small>Formato: [fecha, tipo_consumo, unidad, cantidad, pa√≠s, unidad_negocio, detalle]</small>
      </div>
      <div class="head-right"><span class="badge">HU-06</span></div>
    </header>

    <div class="import-grid">
      <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:analista_importar_excel' %}">
        {% csrf_token %}
        <input type="file" name="archivo" accept=".xlsx,.xls" required>
        <button type="submit" class="btn btn--primary">Subir e importar</button>
      </form>

      <div class="template-help">
        <p><strong>Plantilla de ejemplo:</strong></p>
        <div class="btn-row">
          <a class="btn btn--ghost" href="{% url 'dashboard:analista_descargar_plantilla' 'xlsx' %}">Descargar XLSX</a>
          <a class="btn btn--ghost" href="{% url 'dashboard:analista_descargar_plantilla' 'csv' %}">Descargar CSV</a>
        </div>
        <small class="muted">Las filas inv√°lidas se reportar√°n en un log.</small>
      </div>
    </div>
  </section>

  <!-- =========================================================
      HU-03: INVENTARIO CONSOLIDADO
      ========================================================= -->
  <section id="inventario" class="card">
    <header class="section-head"><div class="head-left"><h3>üìö Inventario consolidado GEI</h3><small>Filtros por a√±o, alcance, fuente, unidad de negocio</small></div><div class="head-right"><span class="badge">HU-03</span></div></header>

    <form class="filters" method="get" action="{% url 'dashboard:analista_inventario' %}">
      <div class="filter-row">
        <select name="anio">
          <option value="">A√±o (todos)</option>
          {% for y in anios %}<option value="{{ y }}" {% if request.GET.anio == y|stringformat:'s' %}selected{% endif %}>{{ y }}</option>{% endfor %}
        </select>
        <select name="alcance">
          <option value="">Alcance (todos)</option>
          <option value="1" {% if request.GET.alcance == '1' %}selected{% endif %}>Alcance 1</option>
          <option value="2" {% if request.GET.alcance == '2' %}selected{% endif %}>Alcance 2</option>
          <option value="3" {% if request.GET.alcance == '3' %}selected{% endif %}>Alcance 3</option>
        </select>
        <select name="fuente">
          <option value="">Fuente (todas)</option>
          <option value="combustible" {% if request.GET.fuente == 'combustible' %}selected{% endif %}>Combustible</option>
          <option value="electricidad" {% if request.GET.fuente == 'electricidad' %}selected{% endif %}>Electricidad</option>
          <option value="refrigerantes" {% if request.GET.fuente == 'refrigerantes' %}selected{% endif %}>Refrigerantes</option>
        </select>
        <select name="unidad_negocio">
          <option value="">Unidad negocio (todas)</option>
          {% for u in unidades_negocio %}
            <option value="{{ u.id }}" {% if request.GET.unidad_negocio == u.id|stringformat:'s' %}selected{% endif %}>{{ u.nombre }}</option>
          {% endfor %}
        </select>
        <button class="btn btn--ghost" type="submit">Aplicar filtros</button>
      </div>
    </form>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Alcance</th><th>Fuente</th><th>Unidad</th><th>Cantidad</th><th>tCO2e</th><th>Pa√≠s</th><th>Unidad negocio</th>
          </tr>
        </thead>
        <tbody>
          {% for r in inventario %}
          <tr>
            <td>{{ r.fecha|date:"Y-m-d" }}</td>
            <td>{{ r.alcance }}</td>
            <td>{{ r.fuente }}</td>
            <td>{{ r.unidad }}</td>
            <td>{{ r.cantidad }}</td>
            <td><strong>{{ r.tco2e }}</strong></td>
            <td>{{ r.pais }}</td>
            <td>{{ r.unidad_negocio__nombre|default:r.unidad_negocio }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="empty">Sin resultados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj %}
    <div class="pagination">
      {% if page_obj.has_previous %}
      <a class="btn btn--ghost" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}
      <span>P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
      <a class="btn btn--ghost" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
      {% endif %}
    </div>
    {% endif %}
  </section>

  <!-- =========================================================
      HU-04: EXPORTAR
      ========================================================= -->
  <section id="exportar" class="card">
    <header class="section-head"><div class="head-left"><h3>‚§µÔ∏è Exportar inventario</h3><small>Archivos para auditor√≠a o an√°lisis externo</small></div><div class="head-right"><span class="badge">HU-04</span></div></header>
    <div class="btn-row">
      <a class="btn btn--ghost" href="{% url 'dashboard:analista_exportar' 'csv' %}?{{ request.GET.urlencode }}">CSV</a>
      <a class="btn btn--ghost" href="{% url 'dashboard:analista_exportar' 'xlsx' %}?{{ request.GET.urlencode }}">XLSX</a>
      <a class="btn btn--ghost" href="{% url 'dashboard:analista_exportar' 'json' %}?{{ request.GET.urlencode }}">JSON</a>
      <a class="btn btn--primary" href="{% url 'dashboard:analista_bitacora' %}">Ver bit√°cora</a>
    </div>
  </section>




</main>

<!-- =========================================================
ESTILOS LIGEROS (LOOK ‚ÄúOPERADOR‚Äù)
  ========================================================= -->
<style>
.dashboard-analista .overview { display:grid; grid-template-columns:repeat(4,minmax(180px,1fr)); gap:12px; margin-bottom:16px; }
.dashboard-analista .kpi strong { font-size:1.4rem; }

.card { border:1px solid #e6e8eb; border-radius:12px; padding:14px; background:#fff; margin-bottom:14px; }
.card--accent { border-color:#dfeee6; background:linear-gradient(180deg,#f7fbf9,#ffffff); }
.section-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.section-head .badge { background:#eaf7f1; border:1px solid #cfe9dc; padding:2px 8px; border-radius:999px; font-size:.75rem; color:#1b7f52; }
.fieldset { border:1px solid #e8edf1; border-radius:10px; padding:10px; margin-bottom:10px; background:#fafcfd; }
.fieldset__legend { font-weight:600; margin-bottom:8px; color:#2c3e50; }
.fieldset__grid { display:grid; grid-template-columns:repeat(4,minmax(200px,1fr)); gap:10px; }
.preview-grid { grid-template-columns:repeat(2,minmax(260px,1fr)); }
.form-grid { display:grid; grid-template-columns:1fr; gap:12px; }
.form-field { display:flex; flex-direction:column; gap:6px; }
.form-actions { display:flex; gap:8px; justify-content:flex-end; }
.table-wrap { overflow:auto; border:1px solid #e5e7eb; border-radius:10px; }
table { width:100%; border-collapse:collapse; }
thead th { background:#f8faf9; text-align:left; padding:10px; border-bottom:1px solid #e5e7eb; }
tbody td { padding:10px; border-bottom:1px solid #eef1f3; }
.empty { text-align:center; color:#888; }
.btn-row { display:flex; gap:8px; flex-wrap:wrap; }
@media (max-width:1100px){ .fieldset__grid{grid-template-columns:repeat(2,1fr);} .overview{grid-template-columns:repeat(2,1fr);} }
@media (max-width:680px){ .fieldset__grid,.preview-grid{grid-template-columns:1fr;} }
</style>

<!-- =========================================================
    JS PREVIEW GHG (CLIENTE). EL OFICIAL VA EN SERVIDOR (HU-07).
  ========================================================= -->
<script>
const FX = {
  combustible: {
    diesel:   { l: 2.68, kg: 3.16, m3: 2.68*1000, base: 2.68 },
    gasolina: { l: 2.31, kg: 3.00, m3: 2.31*1000, base: 2.31 },
    gnl:      { kg: 2.75, m3: 1.90, base: 2.75 },
    glp:      { kg: 3.00, l: 1.50, base: 3.00 }
  },
  electricidad: {
    cl_sic:  { kwh: 0.25/1000, base: 0.25/1000 }, // 0.25 t/MWh
    ar_grid: { kwh: 0.40/1000, base: 0.40/1000 },
    br_grid: { kwh: 0.10/1000, base: 0.10/1000 }
  },
  refrigerantes: { base: { kg: 1.0 } }
};

(function(){
  const tipoConsumo = document.getElementById('tipo_consumo');
  const tipoComb    = document.getElementById('tipo_combustible');
  const factorReg   = document.getElementById('factor_region');
  const unidad      = document.getElementById('unidad');
  const cantidad    = document.getElementById('cantidad');
  const fxPrev      = document.getElementById('factor_preview');
  const tPrev       = document.getElementById('tco2e_preview');
  const onlyComb    = document.querySelector('.only-combustible');
  const onlyElec    = document.querySelector('.only-electricidad');

  function toggleCampos(){
    const v = (tipoConsumo?.value)||'';
    if (onlyComb) onlyComb.hidden = v!=='combustible';
    if (onlyElec) onlyElec.hidden = v!=='electricidad';
  }

  function getFactor(){
    const u = (unidad?.value||'').toLowerCase();
    if (!tipoConsumo) return null;
    const tc = tipoConsumo.value;

    if (tc==='combustible'){
      const t = (tipoComb?.value)||'diesel';
      const tbl = FX.combustible[t]||{};
      return tbl[u] ?? tbl.base ?? null;
    }
    if (tc==='electricidad'){
      const r = (factorReg?.value)||'cl_sic';
      const tbl = FX.electricidad[r]||{};
      return tbl[u] ?? tbl.base ?? null;
    }
    if (tc==='refrigerantes'){
      return FX.refrigerantes.base[u] ?? 1.0;
    }
    return null;
  }

  function calc(){
    const f = getFactor();
    const v = parseFloat(cantidad?.value||'0')||0;
    if (f && v>=0){
      fxPrev.value = f.toFixed(6) + ' tCO2e/' + ((unidad?.value)||'-');
      tPrev.value  = (v*f).toFixed(6) + ' tCO2e';
    } else {
      fxPrev.value = '-';
      tPrev.value  = '-';
    }
  }

  ['change','input'].forEach(evt=>{
    tipoConsumo?.addEventListener(evt, ()=>{toggleCampos(); calc();});
    tipoComb?.addEventListener(evt, calc);
    factorReg?.addEventListener(evt, calc);
    unidad?.addEventListener(evt, calc);
    cantidad?.addEventListener(evt, calc);
  });

  toggleCampos(); calc();
})();
</script>

{% endblock %}
